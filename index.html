<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>saveforascream</title>
  <style>
    :root{ --bg:#000; --fg:#ddd; --muted:#a8a8a8; --line:#2a2a2a; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace; overflow:hidden}
    a{color:var(--fg);text-decoration:none}
    #titre{
      position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
      font-size:clamp(28px,6vw,64px); letter-spacing:.02em; white-space:nowrap;
      cursor:pointer; user-select:none;
    }
    #cloud{position:relative; width:100vw; height:100vh; pointer-events:none;}
    .entry{
      position:absolute; font-size:clamp(14px,2.2vw,22px);
      opacity:.9; transition:transform .5s ease, opacity .25s ease;
      pointer-events:auto; padding:.15rem .25rem; border-radius:.4rem;
    }
    .entry:hover{opacity:1; text-decoration:underline}
    .fade{opacity:0}
    .admin{position:fixed; right:14px; bottom:10px; font-size:12px; color:var(--muted)}
    @media (max-width:520px){ }
  </style>
</head>
<body>
  <div id="titre" aria-label="afficher les entrées">saveforascream</div>
  <div id="cloud" aria-live="polite"></div>
  <a class="admin" href="admin.html">admin</a>

  <script>
    // --------- CONFIG ---------
    const JSON_PATH = 'content/index.json'; // liste plate d’entrées
    const MARGIN = 32;        // marge intérieure
    const AVOID_RADIUS = 140; // zone à éviter autour du titre (px)
    const SHUFFLE_ON = 'none';// aucune réorganisation automatique

    // --------- ÉTAT ---------
    let ENTRIES = [];
    let shown = false;

    const titre = document.getElementById('titre');
    const cloud = document.getElementById('cloud');

    fetch(JSON_PATH + '?_=' + Date.now())
      .then(r => r.json())
      .then(list => {
        // aucune date nécessaire
        ENTRIES = list.slice();
        buildCloud();
      })
      .catch(() => {
        cloud.innerHTML = `<div class="entry" style="left:50%;top:50%;transform:translate(-50%,-50%)">
          Impossible de charger <code>${JSON_PATH}</code></div>`;
      });

    function buildCloud(){
      cloud.innerHTML = '';
      ENTRIES.forEach((it, idx) => {
        const a = document.createElement('a');
        a.className = 'entry fade';
        a.textContent = it.title;
        a.href = it.path;
        a.setAttribute('data-idx', idx);
        a.target = '_self';
        a.addEventListener('click', () => {
          if (SHUFFLE_ON === 'entry' || SHUFFLE_ON === 'both'){
            setTimeout(shufflePositions, 0);
          }
        });
        cloud.appendChild(a);
      });
      positionEntries(true);
    }

    function positionEntries(initial=false){
      const W = window.innerWidth, H = window.innerHeight;
      const cx = W/2, cy = H/2;
      const entries = [...document.querySelectorAll('.entry')];

      entries.forEach(el => {
        let x, y, tries = 0;
        do{
          x = rand(MARGIN, W - MARGIN);
          y = rand(MARGIN, H - MARGIN);
          tries++;
        } while (dist(x, y, cx, cy) < AVOID_RADIUS && tries < 50);

        const tw = Math.min(300, W - 2*MARGIN);
        el.style.maxWidth = tw + 'px';
        el.style.left = x + 'px';
        el.style.top  = y + 'px';

        if (!initial) el.classList.remove('fade');
      });

      if (initial){
        entries.forEach(el => el.classList.add('fade'));
      }
    }

    function toggleShow(){
      shown = !shown;
      const entries = document.querySelectorAll('.entry');
      if (shown){
        entries.forEach(el => el.classList.remove('fade'));
        if (SHUFFLE_ON === 'title' || SHUFFLE_ON === 'both') shufflePositions();
      }else{
        entries.forEach(el => el.classList.add('fade'));
      }
    }

    function shufflePositions(){ positionEntries(false); }
    function rand(min, max){ return Math.random() * (max - min) + min; }
    function dist(x1,y1,x2,y2){ return Math.hypot(x2-x1, y2-y1); }

    titre.addEventListener('click', () => {
      if (!shown){ toggleShow(); }
      else{
        if (SHUFFLE_ON === 'title' || SHUFFLE_ON === 'both') shufflePositions();
        else toggleShow();
      }
    });

    window.addEventListener('resize', () => {
      if (shown) shufflePositions(); else positionEntries(true);
    });
  </script>
</body>
</html>
