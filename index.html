<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — saveforascream</title>
  <style>
    html,body{background:#000;color:#ddd;font-family:ui-monospace, SFMono-Regular, Menlo, monospace;margin:0}
    a{color:#ddd}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    h1{font-size:28px;margin:0 0 12px}
    h2{margin:18px 0 8px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{border:1px solid #333;border-radius:12px;padding:16px;background:#0b0b0b}
    .tag{font-size:12px;opacity:.7}
    .btns a{display:inline-block;margin-right:10px;border:1px solid #444;border-radius:8px;padding:6px 10px;text-decoration:none}
    .btns a:hover{border-color:#ddd}
    .add{margin:20px 0;padding:12px;border:1px dashed #444;border-radius:12px}
    code{background:#111;padding:2px 4px;border-radius:4px}
    .warn{opacity:.8}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>saveforascream — admin</h1>
    <p class="warn">Cette page lit <code>content/index.json</code>. Clique “ouvrir”, “éditer contenu”, “éditer l’index”.</p>

    <div id="lists">Chargement…</div>

    <div class="add">
      <h3>+ Ajouter un contenu</h3>
      <ol>
        <li>Duplique un fichier modèle (ex: <code>/experiences/la-perle.html</code>) et renomme-le.</li>
        <li>Ajoute l’entrée correspondante dans <code>content/index.json</code> (titre, date, chemin…)</li>
        <li>Reviens ici et vérifie qu’il apparaît.</li>
      </ol>
    </div>
  </div>

  <script>
    // Détecte owner/repo pour le lien "éditer sur GitHub"
    function detectRepo(){
      // ex: https://username.github.io/reponame/...
      const hostParts = location.hostname.split('.');
      const owner = hostParts[0]; // username
      const pathParts = location.pathname.split('/').filter(Boolean);
      const repo = pathParts.length ? pathParts[0] : ''; // reponame
      return { owner, repo };
    }
    const { owner, repo } = detectRepo();
    const EDIT_BASE = (owner && repo)
      ? `https://github.com/${owner}/${repo}/edit/main/`
      : null; // si domaine perso, EDIT_BASE sera null -> on n'affiche pas "éditer"

    fetch('content/index.json?_=' + Date.now())
      .then(r => r.json())
      .then(data => renderLists(data))
      .catch(err => {
        document.getElementById('lists').innerHTML =
          "<p>Impossible de charger <code>content/index.json</code>. Vérifie le chemin.</p>";
        console.error(err);
      });

    function renderLists(data){
      const sections = ['experiences','journal'];
      const container = document.getElementById('lists');
      container.innerHTML = '';
      sections.forEach(section=>{
        const items = (data[section]||[]).slice()
          .sort((a,b)=> (b.date||'').localeCompare(a.date||''));
        const sec = document.createElement('div');
        sec.innerHTML = `<h2>${section}</h2>`;
        const grid = document.createElement('div');
        grid.className = 'grid';
        items.forEach(item=>{
          const viewHref = item.path.endsWith('.html') ? item.path : item.path.replace(/\.md$/i, '.html');
          const editHref = EDIT_BASE ? (EDIT_BASE + item.path) : null;
          const editIndexHref = EDIT_BASE ? (EDIT_BASE + 'content/index.json') : null;

          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div class="tag">${item.date || ''}</div>
            <h3 style="margin:6px 0 10px">${item.title}</h3>
            <p style="opacity:.8">${item.summary || ''}</p>
            <div class="btns" style="margin-top:12px">
              <a href="${viewHref}" target="_blank">ouvrir</a>
              ${editHref ? `<a href="${editHref}" target="_blank">éditer contenu</a>` : ''}
              ${editIndexHref ? `<a href="${editIndexHref}" target="_blank">éditer l’index</a>` : ''}
            </div>`;
          grid.appendChild(card);
        });
        sec.appendChild(grid);
        container.appendChild(sec);
      });
    }
  </script>
</body>
</html>
